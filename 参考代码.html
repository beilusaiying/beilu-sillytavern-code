```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>è´éœ²çš„ç¾åŒ–ç•Œé¢ (ä¼˜åŒ–å®éªŒç‰ˆ)</title>
    <!-- å¼•å…¥ Vue 3 å’Œ GSAP åŠ¨ç”»åº“ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼å’Œå˜é‡å®šä¹‰ (ä¸åŸç‰ˆç±»ä¼¼ï¼Œä½†æœ‰ä¼˜åŒ–) --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');
        :root {
            /* é­”æ³•å°‘å¥³ä¸»é¢˜è‰²æ¿ */
            --theme-bg: #fdf6fa; /* æŸ”å’Œçš„ä¹³ç™½/æ·¡ç²‰èƒŒæ™¯ */
            --panel-bg-frosted-blue: rgba(220, 230, 255, 0.7); /* è“è‰²æ¯›ç»ç’ƒ */
            --text-primary: #4a4a6a; /* æš—ç´«ç°è‰²ï¼Œæé«˜å¯è¯»æ€§ */
            --text-secondary: #7a7a9a;
            --text-on-grad: #ffffff;
            --border-color: rgba(180, 180, 220, 0.4);
            --shadow-light: rgba(100, 110, 180, 0.1);
            --shadow-medium: rgba(100, 110, 180, 0.15);

            /* ç”¨æˆ·æŒ‡å®šæ¸å˜ (æ–°ç‰ˆ) */
            --grad-status: linear-gradient(120deg, #9FD6FF 0%, #FFB8E3 100%);
            --grad-inventory: linear-gradient(120deg, #A8C5FF 0%, #C9A8FF 100%);
            --grad-combat: linear-gradient(120deg, #FF8BA0 0%, #FFB8C8 100%);
            --grad-companion: linear-gradient(120deg, #FFB5E3 0%, #D8B8FF 100%);
            --grad-enemy: linear-gradient(120deg, #D56A6A 0%, #B8745B 100%);

            /* é¢æ¿è¾¹æ¡†é¢œè‰² */
            --border-status: #9FD6FF;
            --border-inventory: #A8C5FF;
            --border-combat: #FF8BA0;
            --border-companion: #FFB5E3;
            --border-enemy: #D56A6A;

            /* ä¸˜æ¯”é£æ ¼åº•éƒ¨æ  */
            --qb-bg: #fffafc;
            --qb-eye-color: #ff8a9a;

            /* å¼ºè°ƒè‰²ä¸è¿›åº¦æ¡ */
            --accent-pink: #ff6bab;
            --accent-blue: #6b8cff;
            --accent-red: #ff6b6b;
            --accent-green: #42b983;
            --progress-bg: rgba(0, 0, 0, 0.07);
            --progress-my-hp-bar: linear-gradient(90deg, #ff7ab4, #ffaccf);
            --progress-my-mp-bar: linear-gradient(90deg, #6b8cff, #a8c0ff);
            --progress-my-soul-bar: linear-gradient(90deg, #f0f4f8, #d6e0ff);
            --progress-enemy-hp-bar: linear-gradient(90deg, var(--accent-red), #a73c4e);
            --progress-comp-aff-bar: linear-gradient(90deg, #ffdb6b, #fff0b8);

            /* å­—ä½“ */
            --font-main: 'Inter', 'Noto Sans SC', sans-serif;
            --font-title: 'Orbitron', 'Noto Sans SC', sans-serif;
            --font-numeric: 'Roboto Mono', 'monospace';
        }

        /* --- æ–°å¢ï¼šåŠ¨ç”»å…³é”®å¸§ --- */
        @keyframes gentle-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 171, 207, 0), 0 0 7px rgba(255, 171, 207, 0); }
            50% { box-shadow: 0 0 10px rgba(255, 171, 207, 0.5), 0 0 15px rgba(255, 171, 207, 0.4); }
        }
        @keyframes flash-green {
            0% { color: var(--accent-green); transform: scale(1.25); }
            100% { color: var(--text-primary); transform: scale(1); }
        }
        @keyframes flash-red {
            0% { color: var(--accent-red); transform: scale(1.25); }
            100% { color: var(--text-primary); transform: scale(1); }
        }

        /* --- åŸºç¡€æ ·å¼ --- */
        body { margin: 0; padding: 0; background-color: var(--theme-bg); font-family: var(--font-main); color: var(--text-primary); line-height: 1.6; }
        #app { transition: opacity 0.5s ease; }

        /* --- VueåŠ¨ç”»è¿‡æ¸¡ --- */
        .v-enter-active, .v-leave-active { transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .v-enter-from, .v-leave-to { opacity: 0; transform: translateY(20px); }
        .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s cubic-bezier(0.55, 0, 0.1, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: scale(0.9); }
        .list-leave-active { position: absolute; }

        /* --- ä¸»è¦UIç»„ä»¶æ ·å¼ (ç¾åŒ–ç‰ˆ) --- */
        .top-nav { display: flex; justify-content: stretch; padding: 8px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px var(--shadow-light); position: sticky; top: 0; z-index: 100; }
        .nav-button { flex-grow: 1; border: none; border-radius: 8px; background-color: transparent; color: var(--text-secondary); font-size: 0.9em; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; padding: 10px 5px; gap: 8px; position: relative; overflow: hidden; }
        .nav-button .icon { font-size: 1.4em; transition: transform 0.3s ease; }
        .nav-button:hover { color: var(--text-primary); }
        .nav-button:hover .icon { transform: scale(1.1); }
        .nav-button.active { color: var(--text-on-grad); font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        /* ä¸ºæ¯ä¸ªæŒ‰é’®åº”ç”¨æŒ‡å®šæ¸å˜ */
        .nav-button.active[data-popup="popup-user-status"] { background: var(--grad-status); }
        .nav-button.active[data-popup="popup-user-inventory"] { background: var(--grad-inventory); }
        .nav-button.active[data-popup="popup-combat"] { background: var(--grad-combat); }
        .nav-button.active[data-popup="popup-companions"] { background: var(--grad-companion); }
        .nav-button.active[data-popup="popup-enemies"] { background: var(--grad-enemy); }
        .nav-button.active[data-popup="popup-debug"], .nav-button.active[data-popup="popup-settings"] { background: var(--grad-inventory); }

        .info-bar { padding: 8px 15px; background: rgba(255,255,255,0.5); border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-secondary); text-align: center; white-space: pre-wrap; }
        .main-content { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px var(--shadow-light); border: 1px solid var(--border-color); margin: 20px; white-space: pre-wrap; min-height: 40vh; }
        .content-container { padding-bottom: 80px; /* ä¸ºåº•éƒ¨å›ºå®šæŒ‰é’®å’Œå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´ï¼Œå¹¶å¢åŠ é¢å¤–é—´è· */ }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; }
        .popup-panel {
            position: fixed; left: 0; width: 100%; max-height: 85vh;
            z-index: 1001; display: flex; flex-direction: column;
            box-shadow: 0 5px 30px rgba(100,120,200,0.2);
            border: 2px solid; /* Use thicker border */
            transition: background 0.4s ease, border-color 0.4s ease;
            background: #fff; /* Default background */
            border-color: var(--border-color); /* Default border color */
        }
        /* ä¸ºæ¯ä¸ªé¢æ¿åº”ç”¨ç‹¬ç‰¹çš„æ¸å˜èƒŒæ™¯å’Œè¾¹æ¡† */
        .popup-panel.popup-user-status { background: var(--grad-status); border-color: var(--border-status); }
        .popup-panel.popup-user-inventory { background: var(--grad-inventory); border-color: var(--border-inventory); }
        .popup-panel.popup-combat { background: var(--grad-combat); border-color: var(--border-combat); }
        .popup-panel.popup-companions { background: var(--grad-companion); border-color: var(--border-companion); }
        .popup-panel.popup-enemies { background: var(--grad-enemy); border-color: var(--border-enemy); }
        /* è°ƒè¯•å’Œè®¾ç½®é¢æ¿ä½¿ç”¨ä¸€ä¸ªé»˜è®¤çš„é­”æ³•æ¸å˜ */
        .popup-panel.popup-debug, .popup-panel.popup-settings { background: var(--grad-inventory); border-color: var(--border-inventory); }

        .popup-panel.top-down { top: 0; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .popup-panel.bottom-up { bottom: 0; border-top-left-radius: 20px; border-top-right-radius: 20px; }

        .popup-header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .popup-title { font-size: 1.2em; font-weight: 700; font-family: var(--font-title); color: var(--text-on-grad); text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .popup-close-btn { font-size: 1.5em; font-weight: bold; color: var(--text-on-grad); cursor: pointer; padding: 5px; line-height: 1; transition: transform 0.2s ease; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .popup-close-btn:hover { transform: scale(1.2); color: #fff; }
        .popup-content { padding: 20px; overflow-y: auto; flex-grow: 1; background: rgba(255,255,255,0.8); border-radius: 0 0 18px 18px; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: center; padding: 0; padding-bottom: env(safe-area-inset-bottom); z-index: 100; pointer-events: none; }
        .bottom-popup-button { width: 100%; max-width: 100%; padding: 12px 20px; background-color: var(--qb-bg); border: none; border-top: 1px solid var(--border-color); box-shadow: 0 -4px 20px var(--shadow-light); color: var(--text-primary); font-weight: 600; cursor: pointer; text-align: center; transition: all 0.3s ease; pointer-events: auto; position: relative; }
        .bottom-popup-button:hover { transform: translateY(-3px); box-shadow: 0 -6px 25px var(--shadow-medium); }
        /* QBçœ¼ç› */
        .bottom-popup-button::before, .bottom-popup-button::after { content: ''; position: absolute; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background-color: var(--qb-eye-color); border-radius: 50%; box-shadow: 0 0 5px var(--qb-eye-color); }
        .bottom-popup-button::before { left: 35%; }
        .bottom-popup-button::after { right: 35%; }

        .data-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.95em; display: flex; align-items: center; flex-wrap: wrap; }
        .data-item:last-child { border-bottom: none; }
        .data-item strong { width: 100px; color: var(--text-primary); font-weight: 500; margin-right: 10px; flex-shrink: 0; }
        .data-item span.value { color: var(--text-primary); font-weight: 500; flex-grow: 1; word-break: break-word; white-space: pre-wrap; }
        .progress-bar-container { flex-grow: 1; height: 18px; background-color: var(--progress-bg); border-radius: 9px; overflow: hidden; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .progress-bar-fill { height: 100%; border-radius: 9px; transition: width 0.6s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .progress-bar-text { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8em; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-family: var(--font-numeric); }
        .card-block { background: linear-gradient(150deg, rgba(255, 255, 255, 0.9), rgba(245, 250, 255, 0.95)); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px var(--shadow-light); position: relative; overflow: hidden; transition: all 0.3s ease; animation: gentle-pulse 4s infinite ease-in-out; }
        .card-block h4 { margin: -15px -15px 15px -15px; padding: 10px 15px; color: var(--text-on-grad); font-size: 1.1em; font-weight: 600; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.2); border-radius: 12px 12px 0 0; }
        .companion-card { border: 1px solid var(--accent-pink); }
        .companion-card h4 { background: var(--grad-companion); }
        .enemy-card { border: 1px solid var(--grad-enemy-border); }
        .enemy-card h4 { background: var(--grad-enemy); }
        .no-data-message { color: var(--text-secondary); font-style: italic; text-align: center; padding: 30px 20px; }
        .tip-item {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-blue);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px var(--shadow-light);
        }
        .tip-item.clickable { cursor: pointer; transition: all 0.2s ease; }
        .tip-item.clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-medium); border-left-color: var(--accent-pink); }
        .tip-header { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        .tip-content { font-size: 0.95em; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap; }
        .debug-panel { font-family: var(--font-numeric); font-size: 0.85em; }
        .debug-panel pre { background-color: #2c3e50; color: #f8f8f2; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; }
        .value-display { transition: all 0.3s ease; display: inline-block; }
        .value-changed-up { animation: flash-green 0.7s ease-out; }
        .value-changed-down { animation: flash-red 0.7s ease-out; }

        /* --- æ–°å¢ï¼šå¯äº¤äº’ç‰©å“æ ·å¼ --- */
        .inventory-items, .combat-items { flex-direction: column; align-items: flex-start; }
        .item-list { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 8px; width: 100%; }
        .item-button {
            background: linear-gradient(145deg, #f9faff, #f2f5ff);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: var(--font-main);
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
            box-shadow: 0 1px 3px var(--shadow-light);
        }
        .item-button:hover {
            background: linear-gradient(145deg, #ffffff, #f7f9ff);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }
        .item-button:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; transform: none; border-color: var(--border-color); }
        .item-button:disabled:hover { background-color: #e9ecef; color: #adb5bd; }

        /* --- æ–°å¢ï¼šè®¾ç½®é¢æ¿æ ·å¼ (V2) --- */
        .settings-panel .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .settings-panel .setting-item:last-child { border-bottom: none; }
        .settings-panel .toggle-button {
            padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: all 0.2s ease; min-width: 60px; text-align: center;
        }
        .settings-panel .toggle-button.on { background-color: var(--accent-green); color: white; border-color: var(--accent-green); }
        .settings-panel .toggle-button.off { background-color: var(--text-secondary); color: white; border-color: var(--text-secondary); }
    </style>
</head>
<body>

<div id="app">
    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div class="top-nav">
        <template v-for="button in navButtons" :key="button.id">
            <button v-if="uiSettings[button.id]?.visible ?? true"
                    class="nav-button"
                    :class="{ active: activePopup === button.popupId }"
                    :data-popup="button.popupId"
                    @click="togglePopup(button.popupId)">
                <span class="icon">{{ button.icon }}</span>{{ button.label }}
            </button>
        </template>
    </div>

    <div class="info-bar">
        <span v-if="state.system.time || state.system.location || state.system.plot">
            {{ formatSystemInfo }}
        </span>
        <span v-else>ç³»ç»Ÿä¿¡æ¯åŠ è½½ä¸­...</span>
    </div>

    <div class="content-container">
        <div class="main-content">{{ state.mainContent }}</div>
    </div>

    <!-- å¼¹å‡ºé¢æ¿ -->
    <Transition>
        <div v-if="activePopup" class="popup-overlay" @click="closePopup"></div>
    </Transition>
    <Transition>
        <popup-panel v-if="activePopup" :is-active="!!activePopup" :position="getPopupPosition(activePopup)" :popup-id="activePopup" @close="closePopup">
            <template #title>{{ getPopupTitle(activePopup) }}</template>
            <template #content>
                <div v-if="activePopup === 'popup-user-status'">
                    <div class="data-item"><strong>è½®å›æ¬¡æ•°:</strong> <span class="value value-display" ref="loopCountValueRef">{{ state.userStatus.loopCount || 'N/A' }}</span></div>
                    <div class="data-item"><strong>è½®å›å¤©æ•°:</strong> <span class="value value-display" ref="loopDaysValueRef">{{ state.userStatus.loopDays || 'N/A' }}</span></div>
                    <div class="data-item"><strong>ä½“åŠ›:</strong> <progress-bar :value="state.userStatus.hp" :max="100" color="var(--progress-my-hp-bar)" /></div>
                    <div class="data-item"><strong>é­”åŠ›:</strong> <progress-bar :value="state.userStatus.mp" :max="100" color="var(--progress-my-mp-bar)" /></div>
                    <div class="data-item"><strong>çµé­‚:</strong> <progress-bar :value="state.userStatus.soulPurity" :max="100" color="var(--progress-my-soul-bar)" text-color="#555" /></div>
                    <div class="data-item"><strong>æœè£…:</strong> <span class="value">{{ state.userStatus.clothing || 'N/A' }}</span></div>
                    <div class="data-item"><strong>çŠ¶æ€:</strong> <span class="value">{{ state.userStatus.condition || 'N/A' }}</span></div>
                    <div class="data-item"><strong>åŠ¨ä½œ:</strong> <span class="value">{{ state.userStatus.action || 'N/A' }}</span></div>
                </div>
                <div v-if="activePopup === 'popup-user-inventory'">
                    <div class="data-item">
                        <strong>æ‚²å¹ä¹‹ç§:</strong>
                        <button @click="useGriefSeed" :disabled="!state.userInventory.griefSeeds || state.userInventory.griefSeeds <= 0" class="item-button" style="width: auto; padding: 4px 10px;">
                            <span class="value-display" ref="griefSeedsValueRef">{{ state.userInventory.griefSeeds || '0' }}</span>
                            <span v-if="state.userInventory.griefSeeds > 0" style="margin-left: 8px; font-size: 0.9em; opacity: 0.8;">(ç‚¹å‡»ä½¿ç”¨)</span>
                        </button>
                    </div>
                    <div class="data-item inventory-items">
                        <strong>èƒŒåŒ…ç‰©å“:</strong>
                        <div class="item-list">
                            <template v-if="state.userInventory.items && state.userInventory.items.length">
                                <button v-for="item in state.userInventory.items" :key="item" @click="useItem(item)" class="item-button">
                                    {{ item }}
                                </button>
                            </template>
                            <span v-else class="value">ç©º</span>
                        </div>
                    </div>
                </div>
                <div v-if="activePopup === 'popup-combat'">
                    <div class="data-item combat-items">
                        <strong>é­”æ³•æŠ€èƒ½:</strong>
                        <div class="item-list">
                            <template v-if="state.combat.skills && state.combat.skills.length">
                                <button v-for="skill in state.combat.skills" :key="skill" @click="useSkill(skill)" class="item-button">
                                    {{ skill }}
                                </button>
                            </template>
                            <span v-else class="value">æ— </span>
                        </div>
                    </div>
                    <div class="data-item combat-items">
                        <strong>æ­¦å™¨:</strong>
                        <div class="item-list">
                             <template v-if="state.combat.weapon && state.combat.weapon.length">
                                <!-- æ­¦å™¨åªç”¨äºå±•ç¤ºï¼Œä¸å¯ç‚¹å‡» -->
                                <span v-for="w in state.combat.weapon" :key="w" class="value" style="padding: 6px 0;">{{ w }}</span>
                            </template>
                            <span v-else class="value">æ— </span>
                        </div>
                    </div>
                </div>
                <div v-if="activePopup === 'popup-companions'">
                    <TransitionGroup name="list" tag="div" v-if="state.companions.length">
                        <companion-card v-for="comp in state.companions" :key="comp.id" :companion="comp" />
                    </TransitionGroup>
                    <div v-else class="no-data-message">æš‚æ— åŒä¼´ä¿¡æ¯</div>
                </div>
                <div v-if="activePopup === 'popup-enemies'">
                    <TransitionGroup name="list" tag="div" v-if="state.enemies.length">
                        <enemy-card v-for="(enemy, index) in state.enemies" :key="enemy.name + index" :enemy="enemy" />
                    </TransitionGroup>
                    <div v-else class="no-data-message">æš‚æ— æ•Œäººä¿¡æ¯</div>
                </div>
                <div v-if="activePopup === 'popup-tips'">
                    <TransitionGroup name="list" tag="div" v-if="state.tips.length">
                        <tip-item v-for="(tip, index) in state.tips" :key="index" :tip="tip" @send="sendAsChatMessage" />
                    </TransitionGroup>
                    <div v-else class="no-data-message">æš‚æ— å°è´´å£«</div>
                </div>
                <div v-if="activePopup === 'popup-debug'" class="debug-panel">
                    <h4>åŸå§‹è¾“å…¥ (rawGameTxt)</h4>
                    <pre>{{ rawGameTxt }}</pre>
                    <h4>è§£æåçŠ¶æ€ (JSON)</h4>
                    <pre>{{ JSON.stringify(state, null, 2) }}</pre>
                </div>
                <div v-if="activePopup === 'popup-settings'" class="settings-panel">
                    <div v-for="button in settableNavButtons" :key="button.id" class="setting-item">
                        <span>{{ button.label }}</span>
                        <button @click="uiSettings[button.id].visible = !uiSettings[button.id].visible"
                                class="toggle-button"
                                :class="uiSettings[button.id].visible ? 'on' : 'off'">
                            {{ uiSettings[button.id].visible ? 'å¼€å¯' : 'å…³é—­' }}
                        </button>
                    </div>
                </div>
            </template>
        </popup-panel>
    </Transition>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="bottom-bar">
        <div class="bottom-popup-button" @click="togglePopup('popup-tips')">é­”æ³•å°‘å¥³å°è´´å£«</div>
    </div>
</div>

<script>
const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

// ==================================================================================
// 1. æ•°æ®è§£ææ¨¡å— (Parser) - èŒè´£åˆ†ç¦»ï¼Œåªè´Ÿè´£è§£ææ–‡æœ¬åˆ°JSå¯¹è±¡
// ==================================================================================
function parseGameTxt(rawText) {
    const contentMatch = rawText.match(/<content>([\s\S]*?)<\/content>/);
    const statusMatch = rawText.match(/<status>([\s\S]*?)<\/status>/);

    const initialState = {
        mainContent: "å†…å®¹åŠ è½½å¤±è´¥ã€‚", system: {}, userStatus: {}, userInventory: {},
        combat: { skills: [], weapon: [] }, companions: [], enemies: [], tips: [],
        userInventory: { griefSeeds: 'N/A', items: [] }
    };

    if (contentMatch) initialState.mainContent = contentMatch[1].trim();
    if (!statusMatch) return initialState;

    const statusText = statusMatch[1].trim();
    const lines = statusText.split(/\r?\n/);
    let currentSection = null;
    let currentCompanion = null;
    let currentEnemy = null;
    let lastKey = null;
    let lastObject = null;
    let isCapturingItems = false;

    const sectionTitles = { "ç³»ç»Ÿ": "system", "ç”¨æˆ·çš„çŠ¶æ€": "userStatus", "ç”¨æˆ·èƒŒåŒ…": "userInventory", "æˆ˜æ–—ç‰ˆå—": "combat", "åŒä¼´çŠ¶æ€": "companions", "æ•Œäºº": "enemies", "é­”æ³•å°‘å¥³å°è´´å£«": "tips" };
    const keyMap = { "æ—¶é—´": "time", "åœ°ç‚¹": "location", "ç°åœ¨æ—¶é—´æ®µåŸå‰§æƒ…": "plot", "è½®å›æ¬¡æ•°": "loopCount", "è½®å›å¤©æ•°": "loopDays", "ä½“åŠ›å€¼": "hp", "é­”æ³•å€¼": "mp", "çµé­‚çº¯å‡€åº¦": "soulPurity", "æœè£…": "clothing", "å½“å‰èº«ä½“çŠ¶æ€": "condition", "å½“å‰åŠ¨ä½œ": "action", "æ‚²å¹ä¹‹ç§": "griefSeeds", "èƒŒåŒ…ç‰©å“": "items", "é­”æ³•æŠ€èƒ½": "skills", "æ­¦å™¨": "weapon", "å§“å": "name", "å¥½æ„Ÿåº¦": "affection", "å†…å¿ƒæƒ³æ³•": "thoughts", "åå­—": "name", "ç”Ÿå‘½å€¼": "hp", "ç‰¹æ®Šæœºåˆ¶": "mechanics" };

    for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;

        if (sectionTitles[trimmedLine]) {
            currentSection = sectionTitles[trimmedLine];
            currentCompanion = null; currentEnemy = null; lastKey = null; lastObject = null; isCapturingItems = false;
            continue;
        }

        if (!currentSection) continue;

        if (currentSection === 'tips') {
            const parts = trimmedLine.split(/[:ï¼š](.*)/s);
            const tip = { comment: 'é­”æ³•é¡¾é—®', option: trimmedLine, clickable: true };
            if (parts.length > 1 && parts[1] && parts[1].trim()) {
                tip.comment = parts[0].trim();
                tip.option = parts[1].trim();
            }
            if (tip.option.includes('æš‚æ— å»ºè®®')) tip.clickable = false;
            initialState.tips.push(tip);
            continue;
        }

        if (currentSection === 'companions' && trimmedLine.toLowerCase().startsWith("npc")) {
            currentCompanion = { id: trimmedLine.split(/[:ï¼š]/)[1]?.trim() || Date.now() };
            initialState.companions.push(currentCompanion);
            lastObject = currentCompanion; lastKey = null; isCapturingItems = false;
            continue;
        }


        const parts = trimmedLine.split(/[:ï¼š](.*)/s);
        const key = parts[0].trim();
        const value = parts.length > 1 ? parts[1].trim() : "";

        if (currentSection === 'userInventory' && key === 'èƒŒåŒ…ç‰©å“') {
            isCapturingItems = true;
            initialState.userInventory.items = value ? [value] : [];
            lastObject = initialState.userInventory; lastKey = 'items';
            continue;
        }

        if (parts.length === 1 && lastKey && lastObject && lastKey in lastObject) {
            // If a line has no colon, and we have a record of the last key processed,
            // treat this line as a continuation of the previous key's value.
            // This handles multi-line values for fields like "é­”æ³•æŠ€èƒ½", "æ­¦å™¨", "å½“å‰åŠ¨ä½œ", etc.
            if (isCapturingItems) {
                initialState.userInventory.items.push(trimmedLine);
            } else {
                if (lastKey === 'skills' || lastKey === 'weapon') {
                    if (lastObject[lastKey].length === 1 && lastObject[lastKey][0] === '') {
                        lastObject[lastKey][0] = trimmedLine;
                    } else {
                        lastObject[lastKey].push(trimmedLine);
                    }
                } else {
                    lastObject[lastKey] += (lastObject[lastKey] ? "\n" : "") + trimmedLine;
                }
            }
            continue;
        }

        const mappedKey = keyMap[key];
        if (!mappedKey) continue;

        switch (currentSection) {
            case 'system': lastObject = initialState.system; break;
            case 'userStatus': lastObject = initialState.userStatus; break;
            case 'combat': lastObject = initialState.combat; break;
            case 'userInventory': lastObject = initialState.userInventory; break;
            case 'companions': lastObject = currentCompanion; break;
            case 'enemies':
                if (key === "åå­—") {
                    currentEnemy = {};
                    initialState.enemies.push(currentEnemy);
                }
                lastObject = currentEnemy;
                break;
        }
        if (lastObject) {
            if (mappedKey === 'skills' || mappedKey === 'weapon') {
                lastObject[mappedKey] = value ? [value] : [];
            } else {
                lastObject[mappedKey] = value;
            }
            lastKey = mappedKey;
        }
    }
    return initialState;
}

// ==================================================================================
// 2. Vue åº”ç”¨å®šä¹‰
// ==================================================================================
const app = createApp({
    setup() {
        // --- å“åº”å¼çŠ¶æ€ (Model) ---
        const rawGameTxt = ref(`$1`);
        const state = reactive({
            mainContent: "æ•…äº‹å†…å®¹åŠ è½½ä¸­...", system: {}, userStatus: {},
            userInventory: { griefSeeds: 'N/A', items: [] },
            combat: { skills: [], weapon: [] }, companions: [], enemies: [], tips: []
        });
        const activePopup = ref(null);
        const loopCountValueRef = ref(null);
        const loopDaysValueRef = ref(null);
        const griefSeedsValueRef = ref(null);
        const uiSettings = reactive({});

        // --- å¯¼èˆªå’ŒUIçŠ¶æ€ ---
        const navButtons = [
            { id: 'status', icon: 'â—‡', label: 'ä½ çš„çŠ¶æ€', popupId: 'popup-user-status' },
            { id: 'inventory', icon: 'â—', label: 'ä½ çš„èƒŒåŒ…', popupId: 'popup-user-inventory' },
            { id: 'combat', icon: 'âš”', label: 'æˆ˜æ–—ä¸èƒ½åŠ›', popupId: 'popup-combat' },
            { id: 'companions', icon: 'â™¡', label: 'åŒä¼´çŠ¶æ€', popupId: 'popup-companions' },
            { id: 'enemies', icon: 'â˜ ', label: 'æ•Œäºº', popupId: 'popup-enemies' },
            { id: 'debug', icon: 'ğŸ', label: 'è°ƒè¯•', popupId: 'popup-debug' },
            { id: 'settings', icon: 'âš™', label: 'è®¾ç½®', popupId: 'popup-settings' },
        ];

        const settableNavButtons = computed(() => navButtons.filter(b => b.id !== 'settings'));

        // --- è®¡ç®—å±æ€§ (Computed Properties) ---
        const formatSystemInfo = computed(() => {
            return [
                state.system.time ? `æ—¶é—´: ${state.system.time}` : '',
                state.system.location ? `åœ°ç‚¹: ${state.system.location}` : '',
                state.system.plot ? `ç°åœ¨æ—¶é—´æ®µåŸå‰§æƒ…: ${state.system.plot}` : ''
            ].filter(Boolean).join(' | ');
        });

        // --- æ–¹æ³• (Methods) ---
        const togglePopup = (popupId) => {
            activePopup.value = activePopup.value === popupId ? null : popupId;
        };

        const closePopup = () => { activePopup.value = null; };

        const useGriefSeed = () => {
            if (state.userInventory.griefSeeds > 0) {
                sendAsChatMessage('ä½¿ç”¨ æ‚²å¹ä¹‹ç§');
            }
        };

        const getPopupTitle = (popupId) => navButtons.find(b => b.popupId === popupId)?.label || '';
        const getPopupPosition = (popupId) => popupId === 'popup-tips' ? 'bottom-up' : 'top-down';

        const sendAsChatMessage = (message) => {
            if (typeof createChatMessages === 'function' && typeof triggerSlash === 'function') {
                (async () => {
                    await createChatMessages([{ role: 'user', message: message }]);
                    triggerSlash('/trigger');
                })();
            } else {
                console.warn("SillyTavern API not found.");
                alert(`åœ¨SillyTavernç¯å¢ƒå¤–æ— æ³•å‘é€æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹ï¼š\n${message}`);
            }
        };

        const useItem = (itemString) => {
            const itemName = itemString.split(/x\d*$/)[0].trim();
            if (itemName) {
                sendAsChatMessage(`ä½¿ç”¨ ${itemName}`);
            }
        };

        const useSkill = (skillName) => {
            sendAsChatMessage(`ä½¿ç”¨ ${skillName}`);
        };

        const applyChangeAnimation = (element, newValue, oldValue) => {
            if (!element || newValue === oldValue) return;
            const newNum = parseFloat(newValue);
            const oldNum = parseFloat(oldValue);
            if (isNaN(newNum) || isNaN(oldNum)) return;

            const changeClass = newNum > oldNum ? 'value-changed-up' : 'value-changed-down';
            element.classList.add(changeClass);
            setTimeout(() => {
                element.classList.remove(changeClass);
            }, 700);
        };

        // --- ç”Ÿå‘½å‘¨æœŸé’©å­ ---
        onMounted(() => {
            // åŠ è½½UIè®¾ç½®
            const savedSettings = localStorage.getItem('tavernHelperUISettings');
            const defaultSettings = navButtons.reduce((acc, btn) => {
                acc[btn.id] = { visible: true };
                return acc;
            }, {});

            if (savedSettings) {
                Object.assign(uiSettings, { ...defaultSettings, ...JSON.parse(savedSettings) });
            } else {
                Object.assign(uiSettings, defaultSettings);
            }

            // ç›‘è§†è®¾ç½®å˜åŒ–å¹¶ä¿å­˜
            watch(uiSettings, (newSettings) => {
                localStorage.setItem('tavernHelperUISettings', JSON.stringify(newSettings));
            }, { deep: true });

            // æ›´æ–°é€»è¾‘ (Update)
            const parsedData = parseGameTxt(rawGameTxt.value);
            Object.assign(state, parsedData);

            // --- æ–°å¢ï¼šç›‘è§†æ•°å€¼å˜åŒ–ä»¥åº”ç”¨åŠ¨ç”» ---
            watch(() => state.userStatus.loopCount, (newVal, oldVal) => applyChangeAnimation(loopCountValueRef.value, newVal, oldVal));
            watch(() => state.userStatus.loopDays, (newVal, oldVal) => applyChangeAnimation(loopDaysValueRef.value, newVal, oldVal));
            watch(() => state.userInventory.griefSeeds, (newVal, oldVal) => applyChangeAnimation(griefSeedsValueRef.value, newVal, oldVal));
        });

        return {
            state,
            rawGameTxt,
            activePopup, loopCountValueRef, loopDaysValueRef, griefSeedsValueRef, uiSettings,
            navButtons, settableNavButtons,
            formatSystemInfo,
            togglePopup,
            closePopup,
            getPopupTitle,
            getPopupPosition,
            sendAsChatMessage,
            useItem,
            useSkill,
            useGriefSeed
        };
    }
});

// ==================================================================================
// 3. Vue ç»„ä»¶å®šä¹‰ (View Components)
// ==================================================================================
app.component('popup-panel', {
    props: ['isActive', 'position', 'popupId'],
    emits: ['close'],
    template: `
        <div class="popup-panel" :class="[position, popupId]">
            <div class="popup-header">
                <h3 class="popup-title"><slot name="title"></slot></h3>
                <span class="popup-close-btn" @click="$emit('close')">&times;</span>
            </div>
            <div class="popup-content"><slot name="content"></slot></div>
        </div>
    `
});

app.component('progress-bar', {
    props: { value: [String, Number], max: { type: Number, default: 100 }, color: String, textColor: { type: String, default: '#fff' } },
    setup(props) {
        const animatedValue = ref(0);
        const displayValue = computed(() => Math.round(animatedValue.value));
        const percentage = computed(() => (animatedValue.value / props.max) * 100);

        watch(() => props.value, (newValue) => {
            gsap.to(animatedValue, { duration: 0.8, value: parseFloat(newValue) || 0, ease: "power2.out" });
        }, { immediate: true });

        return { displayValue, percentage };
    },
    template: `
        <div class="progress-bar-container">
            <div class="progress-bar-fill" :style="{ width: percentage + '%', background: color }"></div>
            <span class="progress-bar-text" :style="{ color: textColor }">{{ displayValue }} / {{ max }}</span>
        </div>
    `
});

app.component('companion-card', {
    props: ['companion'],
    template: `
        <div class="card-block companion-card">
            <h4>{{ companion.name || 'æœªçŸ¥åŒä¼´' }}</h4>
            <div class="data-item"><strong>ä½“åŠ›:</strong> <progress-bar :value="companion.hp" color="var(--progress-my-hp-bar)" /></div>
            <div class="data-item"><strong>é­”åŠ›:</strong> <progress-bar :value="companion.mp" color="var(--progress-my-mp-bar)" /></div>
            <div class="data-item"><strong>å¥½æ„Ÿ:</strong> <progress-bar :value="companion.affection" :max="200" :min="-100" color="var(--progress-comp-aff-bar)" text-color="#6f4e00" /></div>
            <div class="data-item"><strong>çµé­‚:</strong> <progress-bar :value="companion.soulPurity" color="var(--progress-my-soul-bar)" text-color="#555" /></div>
            <div class="data-item"><strong>æ‚²å¹ä¹‹ç§:</strong> <span class="value">{{ companion.griefSeeds || 'N/A' }}</span></div>
            <div class="data-item"><strong>å¿ƒå£°:</strong> <span class="value">{{ companion.thoughts || 'N/A' }}</span></div>
            <div class="data-item"><strong>æœè£…:</strong> <span class="value">{{ companion.clothing || 'N/A' }}</span></div>
            <div class="data-item"><strong>åŠ¨ä½œ:</strong> <span class="value">{{ companion.action || 'N/A' }}</span></div>
        </div>
    `
});

app.component('enemy-card', {
    props: ['enemy'],
    template: `
        <div class="card-block enemy-card">
            <h4>{{ enemy.name || 'æœªçŸ¥æ•Œäºº' }}</h4>
            <div class="data-item"><strong>ç”Ÿå‘½:</strong> <progress-bar :value="enemy.hp" color="var(--progress-enemy-hp-bar)" /></div>
            <div class="data-item"><strong>æœºåˆ¶:</strong> <span class="value">{{ enemy.mechanics || 'N/A' }}</span></div>
        </div>
    `
});

app.component('tip-item', {
    props: ['tip'],
    emits: ['send'],
    template: `
        <div class="tip-item" :class="{ clickable: tip.clickable }" @click="tip.clickable && $emit('send', tip.option)">
            <div class="tip-header">âœ§ {{ tip.comment }}</div>
            <div class="tip-content">{{ tip.option }}</div>
        </div>
    `
});

// ==================================================================================
// 4. æŒ‚è½½åº”ç”¨
// ==================================================================================
app.mount('#app');

</script>
</body>
</html>
```
