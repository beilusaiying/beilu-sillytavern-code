<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>è´éœ²çš„ç¾åŒ–ç•Œé¢ (æ·±åº¦æ³¨é‡Šç‰ˆ)</title>

    <!--
      ==================================================================================
      == æ ¸å¿ƒé›†æˆæœºåˆ¶ä¸æ¶æ„æ€»è§ˆ (Core Integration and Architecture)
      ==================================================================================
      1. é›†æˆæœºåˆ¶ (Integration Mechanism):
         - æœ¬æ–‡ä»¶é€šè¿‡ SillyTavern çš„â€œæ­£åˆ™è„šæœ¬ (Regex Scripting)â€åŠŸèƒ½æ³¨å…¥åˆ°èŠå¤©ç•Œé¢ä¸­ã€‚
         - SillyTavern ä¼šåœ¨AIçš„è¾“å‡ºä¸­æŸ¥æ‰¾ç‰¹å®šçš„æ ‡ç­¾ï¼Œä¾‹å¦‚ <game_txt>...</game_txt>ã€‚
         - æ‰¾åˆ°åï¼ŒSillyTavern ä¼šç”¨è¿™ä¸ªHTMLæ–‡ä»¶çš„ *å…¨éƒ¨å†…å®¹* æ›¿æ¢æ‰ <game_txt> æ ‡ç­¾æœ¬èº«ã€‚
         - è„šæœ¬å†…éƒ¨çš„ `const rawGameTxt = ref(`$1`);` è¿™è¡Œä»£ç æ˜¯å…³é”®ï¼Œ$1 ä¼šè¢« SillyTavern æ›¿æ¢ä¸º <game_txt> æ ‡ç­¾ *å†…éƒ¨* çš„åŸå§‹æ–‡æœ¬ã€‚
         - è¿™å°±å®Œæˆäº†ä» SillyTavern åˆ°æœ¬ Vue åº”ç”¨çš„å•å‘æ•°æ®æ³¨å…¥ã€‚

      2. æ¶æ„æ¨¡å¼ (MVU - Model-View-Update):
         æœ¬é¡¹ç›®éµå¾ªäº†â€œé…’é¦†åŠ©æ‰‹ (Tavern Helper)â€å®˜æ–¹æ¨èçš„ MVU è®¾è®¡æ¨¡å¼ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸é€‚åˆå“åº”å¼UIçš„æ¶æ„ã€‚
         - Model (æ¨¡å‹): ç”± Vue çš„ `reactive` API åˆ›å»ºçš„ `state` å¯¹è±¡ã€‚å®ƒæ˜¯åº”ç”¨æ‰€æœ‰æ•°æ®çš„å”¯ä¸€çœŸå®æ¥æº (Single Source of Truth)ã€‚
         - View (è§†å›¾): HTMLæ¨¡æ¿éƒ¨åˆ†ä»¥åŠæ‰€æœ‰çš„ Vue ç»„ä»¶ (`<progress-bar>`, `<companion-card>` ç­‰)ã€‚å®ƒä»¬è´Ÿè´£ä»¥å£°æ˜å¼çš„æ–¹å¼â€œå±•ç¤ºâ€ Model ä¸­çš„æ•°æ®ã€‚
         - Update (æ›´æ–°): `parseGameTxt` å‡½æ•°å’Œæ‰€æœ‰åœ¨ `setup()` ä¸­å®šä¹‰çš„ methods (å¦‚ `useSkill`, `togglePopup`)ã€‚å®ƒä»¬è´Ÿè´£æ ¹æ®æ¥è‡ª SillyTavern çš„åŸå§‹è¾“å…¥æˆ–ç”¨æˆ·çš„äº¤äº’æ¥â€œæ›´æ–°â€ Modelã€‚å½“ Model æ›´æ–°åï¼ŒVue ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“ Viewã€‚
    -->

    <!-- å¼•å…¥å¤–éƒ¨åº“ï¼šVue.js ç”¨äºæ„å»ºå“åº”å¼UIï¼ŒGSAP ç”¨äºå®ç°æµç•…çš„åŠ¨ç”»æ•ˆæœã€‚ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
      /* --- å­—ä½“ä¸åŸºç¡€å˜é‡å®šä¹‰ --- */
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');

      /*
         * CSSè‡ªå®šä¹‰å±æ€§ï¼ˆå˜é‡ï¼‰ç³»ç»Ÿï¼š
         * è¿™ç§è®¾è®¡ä½¿å¾—ä¸»é¢˜é¢œè‰²ã€å­—ä½“å’Œå¸ƒå±€çš„ç»Ÿä¸€ç®¡ç†å’Œä¿®æ”¹å˜å¾—éå¸¸æ–¹ä¾¿ã€‚
         * æ•´ä¸ªUIçš„ç¾å­¦é£æ ¼éƒ½ç”±æ­¤å¤„çš„å˜é‡é©±åŠ¨ã€‚
         */
      :root {
        /* é­”æ³•å°‘å¥³ä¸»é¢˜è‰²æ¿ */
        --theme-bg: #fdf6fa; /* æŸ”å’Œçš„ä¹³ç™½/æ·¡ç²‰èƒŒæ™¯ï¼Œè¥é€ æ¢¦å¹»æ„Ÿ */
        --panel-bg-frosted-blue: rgba(220, 230, 255, 0.7); /* è“è‰²æ¯›ç»ç’ƒæ•ˆæœï¼Œç”¨äºæ¬¡è¦å…ƒç´  */
        --text-primary: #4a4a6a; /* æš—ç´«ç°è‰²ï¼Œåœ¨æ·¡è‰²èƒŒæ™¯ä¸Šä¿è¯è¶³å¤Ÿçš„å¯è¯»æ€§ */
        --text-secondary: #7a7a9a; /* ç”¨äºè¾…åŠ©æ€§æ–‡å­— */
        --text-on-grad: #ffffff; /* ç”¨äºæ¸å˜èƒŒæ™¯ä¸Šçš„æ–‡å­—ï¼Œä¿è¯å¯¹æ¯”åº¦ */
        --border-color: rgba(180, 180, 220, 0.4); /* ç»Ÿä¸€çš„è¾¹æ¡†é¢œè‰² */
        --shadow-light: rgba(100, 110, 180, 0.1); /* ç»Ÿä¸€çš„æµ…é˜´å½± */
        --shadow-medium: rgba(100, 110, 180, 0.15); /* ç»Ÿä¸€çš„ä¸­ç­‰é˜´å½± */

        /* å„é¢æ¿å’ŒæŒ‰é’®çš„ä¸“å±æ¸å˜è‰²ï¼Œèµ‹äºˆæ¯ä¸ªåŠŸèƒ½åŒºç‹¬ç‰¹çš„è§†è§‰æ ‡è¯† */
        --grad-status: linear-gradient(120deg, #9fd6ff 0%, #ffb8e3 100%);
        --grad-inventory: linear-gradient(120deg, #a8c5ff 0%, #c9a8ff 100%);
        --grad-combat: linear-gradient(120deg, #ff8ba0 0%, #ffb8c8 100%);
        --grad-companion: linear-gradient(120deg, #ffb5e3 0%, #d8b8ff 100%);
        --grad-enemy: linear-gradient(120deg, #d56a6a 0%, #b8745b 100%);

        /* ä¸æ¸å˜è‰²é…å¥—çš„é¢æ¿è¾¹æ¡†é¢œè‰² */
        --border-status: #9fd6ff;
        --border-inventory: #a8c5ff;
        --border-combat: #ff8ba0;
        --border-companion: #ffb5e3;
        --border-enemy: #d56a6a;

        /* ä¸˜æ¯”é£æ ¼åº•éƒ¨æ çš„ä¸“å±é¢œè‰² */
        --qb-bg: #fffafc;
        --qb-eye-color: #ff8a9a;

        /* å¼ºè°ƒè‰²ä¸è¿›åº¦æ¡é¢œè‰² */
        --accent-pink: #ff6bab;
        --accent-blue: #6b8cff;
        --accent-red: #ff6b6b;
        --accent-green: #42b983;
        --progress-bg: rgba(0, 0, 0, 0.07); /* è¿›åº¦æ¡èƒŒæ™¯è‰² */
        /* å„ç§ä¸åŒç”¨é€”çš„è¿›åº¦æ¡å¡«å……è‰² */
        --progress-my-hp-bar: linear-gradient(90deg, #ff7ab4, #ffaccf);
        --progress-my-mp-bar: linear-gradient(90deg, #6b8cff, #a8c0ff);
        --progress-my-soul-bar: linear-gradient(90deg, #f0f4f8, #d6e0ff);
        --progress-enemy-hp-bar: linear-gradient(90deg, var(--accent-red), #a73c4e);
        --progress-comp-aff-bar: linear-gradient(90deg, #ffdb6b, #fff0b8);

        /* ç»Ÿä¸€å­—ä½“å®šä¹‰ */
        --font-main: 'Inter', 'Noto Sans SC', sans-serif; /* ä¸»è¦å†…å®¹å­—ä½“ */
        --font-title: 'Orbitron', 'Noto Sans SC', sans-serif; /* æ ‡é¢˜å­—ä½“ï¼Œæœ‰ç§‘æŠ€æ„Ÿ */
        --font-numeric: 'Roboto Mono', 'monospace'; /* æ•°å­—å’Œä»£ç å­—ä½“ï¼Œä¿è¯ç­‰å®½å¯¹é½ */
      }

      /* --- åŠ¨ç”»å…³é”®å¸§å®šä¹‰ --- */
      @keyframes gentle-pulse {
        0%,
        100% {
          box-shadow:
            0 0 5px rgba(255, 171, 207, 0),
            0 0 7px rgba(255, 171, 207, 0);
        }
        50% {
          box-shadow:
            0 0 10px rgba(255, 171, 207, 0.5),
            0 0 15px rgba(255, 171, 207, 0.4);
        }
      }
      /* ç”¨äºæ•°å€¼å¢åŠ æ—¶çš„â€œé—ªçƒâ€åŠ¨ç”» */
      @keyframes flash-green {
        0% {
          color: var(--accent-green);
          transform: scale(1.25);
        }
        100% {
          color: var(--text-primary);
          transform: scale(1);
        }
      }
      /* ç”¨äºæ•°å€¼å‡å°‘æ—¶çš„â€œé—ªçƒâ€åŠ¨ç”» */
      @keyframes flash-red {
        0% {
          color: var(--accent-red);
          transform: scale(1.25);
        }
        100% {
          color: var(--text-primary);
          transform: scale(1);
        }
      }

      /* --- åŸºç¡€å¸ƒå±€ä¸æ ·å¼ --- */
      body {
        margin: 0;
        padding: 0;
        background-color: var(--theme-bg);
        font-family: var(--font-main);
        color: var(--text-primary);
        line-height: 1.6;
      }
      #app {
        transition: opacity 0.5s ease;
      }

      /* --- Vue è¿‡æ¸¡åŠ¨ç”» --- */
      .v-enter-active,
      .v-leave-active {
        transition:
          opacity 0.4s ease,
          transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .v-enter-from,
      .v-leave-to {
        opacity: 0;
        transform: translateY(20px);
      }
      .list-move,
      .list-enter-active,
      .list-leave-active {
        transition: all 0.5s cubic-bezier(0.55, 0, 0.1, 1);
      }
      .list-enter-from,
      .list-leave-to {
        opacity: 0;
        transform: scale(0.9);
      }
      .list-leave-active {
        position: absolute;
      }

      /* --- ä¸»è¦UIç»„ä»¶æ ·å¼ (ç¾åŒ–ç‰ˆ) --- */
      .top-nav {
        display: flex;
        justify-content: stretch;
        padding: 8px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 10px var(--shadow-light);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .nav-button {
        flex-grow: 1;
        border: none;
        border-radius: 8px;
        background-color: transparent;
        color: var(--text-secondary);
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        padding: 10px 5px;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }
      .nav-button .icon {
        font-size: 1.4em;
        transition: transform 0.3s ease;
      }
      .nav-button:hover {
        color: var(--text-primary);
      }
      .nav-button:hover .icon {
        transform: scale(1.1);
      }
      .nav-button.active {
        color: var(--text-on-grad);
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      /* ä¸ºæ¯ä¸ªæ¿€æ´»çš„æŒ‰é’®åº”ç”¨å…¶ä¸“å±çš„æ¸å˜èƒŒæ™¯ */
      .nav-button.active[data-popup='popup-user-status'] {
        background: var(--grad-status);
      }
      .nav-button.active[data-popup='popup-user-inventory'] {
        background: var(--grad-inventory);
      }
      .nav-button.active[data-popup='popup-combat'] {
        background: var(--grad-combat);
      }
      .nav-button.active[data-popup='popup-companions'] {
        background: var(--grad-companion);
      }
      .nav-button.active[data-popup='popup-enemies'] {
        background: var(--grad-enemy);
      }
      .nav-button.active[data-popup='popup-debug'],
      .nav-button.active[data-popup='popup-settings'] {
        background: var(--grad-inventory);
      }

      .info-bar {
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9em;
        color: var(--text-secondary);
        text-align: center;
        white-space: pre-wrap;
      }
      .main-content {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px var(--shadow-light);
        border: 1px solid var(--border-color);
        margin: 20px;
        white-space: pre-wrap;
        min-height: 40vh;
      }
      .content-container {
        padding-bottom: 80px; /* ä¸ºåº•éƒ¨å›ºå®šæŒ‰é’®å’Œå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´ï¼Œå¹¶å¢åŠ é¢å¤–é—´è· */
      }
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 1000;
      }
      .popup-panel {
        position: fixed;
        left: 0;
        width: 100%;
        max-height: 85vh;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        box-shadow: 0 5px 30px rgba(100, 120, 200, 0.2);
        border: 2px solid;
        transition:
          background 0.4s ease,
          border-color 0.4s ease;
        background: #fff;
        border-color: var(--border-color);
      }
      /* ä¸ºæ¯ä¸ªé¢æ¿åº”ç”¨ç‹¬ç‰¹çš„æ¸å˜èƒŒæ™¯å’Œè¾¹æ¡†ï¼Œå¢å¼ºè§†è§‰åŒºåˆ†åº¦ */
      .popup-panel.popup-user-status {
        background: var(--grad-status);
        border-color: var(--border-status);
      }
      .popup-panel.popup-user-inventory {
        background: var(--grad-inventory);
        border-color: var(--border-inventory);
      }
      .popup-panel.popup-combat {
        background: var(--grad-combat);
        border-color: var(--border-combat);
      }
      .popup-panel.popup-companions {
        background: var(--grad-companion);
        border-color: var(--border-companion);
      }
      .popup-panel.popup-enemies {
        background: var(--grad-enemy);
        border-color: var(--border-enemy);
      }
      .popup-panel.popup-debug,
      .popup-panel.popup-settings {
        background: var(--grad-inventory);
        border-color: var(--border-inventory);
      }

      .popup-panel.top-down {
        top: 0;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
      }
      .popup-panel.bottom-up {
        bottom: 0;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }

      .popup-header {
        padding: 15px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .popup-title {
        font-size: 1.2em;
        font-weight: 700;
        font-family: var(--font-title);
        color: var(--text-on-grad);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .popup-close-btn {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--text-on-grad);
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        transition: transform 0.2s ease;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .popup-close-btn:hover {
        transform: scale(1.2);
        color: #fff;
      }
      .popup-content {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 0 0 18px 18px;
      }
      .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom);
        z-index: 100;
        pointer-events: none;
      }
      .bottom-popup-button {
        width: 100%;
        max-width: 100%;
        padding: 12px 20px;
        background-color: var(--qb-bg);
        border: none;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -4px 20px var(--shadow-light);
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
        pointer-events: auto;
        position: relative;
      }
      .bottom-popup-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 -6px 25px var(--shadow-medium);
      }
      /* ä¸˜æ¯”(QB)é£æ ¼çš„çœ¼ç›è£…é¥°ï¼Œå¢åŠ è¶£å‘³æ€§ */
      .bottom-popup-button::before,
      .bottom-popup-button::after {
        content: '';
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background-color: var(--qb-eye-color);
        border-radius: 50%;
        box-shadow: 0 0 5px var(--qb-eye-color);
      }
      .bottom-popup-button::before {
        left: 35%;
      }
      .bottom-popup-button::after {
        right: 35%;
      }

      .data-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95em;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }
      .data-item:last-child {
        border-bottom: none;
      }
      .data-item strong {
        width: 100px;
        color: var(--text-primary);
        font-weight: 500;
        margin-right: 10px;
        flex-shrink: 0;
      }
      .data-item span.value {
        color: var(--text-primary);
        font-weight: 500;
        flex-grow: 1;
        word-break: break-word;
        white-space: pre-wrap;
      }
      .progress-bar-container {
        flex-grow: 1;
        height: 18px;
        background-color: var(--progress-bg);
        border-radius: 9px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .progress-bar-fill {
        height: 100%;
        border-radius: 9px;
        transition: width 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
      }
      .progress-bar-text {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8em;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        font-family: var(--font-numeric);
      }
      .card-block {
        background: linear-gradient(150deg, rgba(255, 255, 255, 0.9), rgba(245, 250, 255, 0.95));
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px var(--shadow-light);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        animation: gentle-pulse 4s infinite ease-in-out;
      }
      .card-block h4 {
        margin: -15px -15px 15px -15px;
        padding: 10px 15px;
        color: var(--text-on-grad);
        font-size: 1.1em;
        font-weight: 600;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 12px 12px 0 0;
      }
      .companion-card {
        border: 1px solid var(--accent-pink);
      }
      .companion-card h4 {
        background: var(--grad-companion);
      }
      .enemy-card {
        border: 1px solid var(--grad-enemy-border);
      }
      .enemy-card h4 {
        background: var(--grad-enemy);
      }
      .no-data-message {
        color: var(--text-secondary);
        font-style: italic;
        text-align: center;
        padding: 30px 20px;
      }
      .tip-item {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-left: 4px solid var(--accent-blue);
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 12px;
        box-shadow: 0 2px 5px var(--shadow-light);
      }
      .tip-item.clickable {
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tip-item.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-medium);
        border-left-color: var(--accent-pink);
      }
      .tip-header {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 500;
      }
      .tip-content {
        font-size: 0.95em;
        color: var(--text-primary);
        line-height: 1.6;
        white-space: pre-wrap;
      }
      .debug-panel {
        font-family: var(--font-numeric);
        font-size: 0.85em;
      }
      .debug-panel pre {
        background-color: #2c3e50;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 8px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .value-display {
        transition: all 0.3s ease;
        display: inline-block;
      }
      .value-changed-up {
        animation: flash-green 0.7s ease-out;
      }
      .value-changed-down {
        animation: flash-red 0.7s ease-out;
      }

      /* --- å¯äº¤äº’ç‰©å“/æŠ€èƒ½æŒ‰é’®æ ·å¼ --- */
      .inventory-items,
      .combat-items {
        flex-direction: column;
        align-items: flex-start;
      }
      .item-list {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        margin-top: 8px;
        width: 100%;
      }
      .item-button {
        background: linear-gradient(145deg, #f9faff, #f2f5ff);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 14px;
        font-family: var(--font-main);
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        width: 100%;
        box-shadow: 0 1px 3px var(--shadow-light);
      }
      .item-button:hover {
        background: linear-gradient(145deg, #ffffff, #f7f9ff);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px var(--shadow-medium);
      }
      .item-button:disabled {
        background-color: #e9ecef;
        color: #adb5bd;
        cursor: not-allowed;
        transform: none;
        border-color: var(--border-color);
      }
      .item-button:disabled:hover {
        background-color: #e9ecef;
        color: #adb5bd;
      }

      /* --- è®¾ç½®é¢æ¿æ ·å¼ --- */
      .settings-panel .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
      }
      .settings-panel .setting-item:last-child {
        border-bottom: none;
      }
      .settings-panel .toggle-button {
        padding: 4px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 60px;
        text-align: center;
      }
      .settings-panel .toggle-button.on {
        background-color: var(--accent-green);
        color: white;
        border-color: var(--accent-green);
      }
      .settings-panel .toggle-button.off {
        background-color: var(--text-secondary);
        color: white;
        border-color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <!-- Vue åº”ç”¨çš„æ ¹èŠ‚ç‚¹, Vueå®ä¾‹å°†æŒ‚è½½åˆ°è¿™é‡Œ -->
    <div id="app">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  (Viewçš„ä¸€éƒ¨åˆ†) -->
      <div class="top-nav">
        <!-- ä½¿ç”¨ v-for å¾ªç¯éå† navButtons æ•°ç»„æ¥åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
        <template v-for="button in navButtons" :key="button.id">
          <!-- v-if æŒ‡ä»¤æ ¹æ® uiSettings ä¸­çš„å¯è§æ€§è®¾ç½®æ¥å†³å®šæ˜¯å¦æ¸²æŸ“æ­¤æŒ‰é’® -->
          <button
            v-if="uiSettings[button.id]?.visible ?? true"
            class="nav-button"
            :class="{ active: activePopup === button.popupId }"
            :data-popup="button.popupId"
            @click="togglePopup(button.popupId)"
          >
            <span class="icon">{{ button.icon }}</span>{{ button.label }}
          </button>
        </template>
      </div>

      <!-- ä¸­é—´çš„ä¿¡æ¯æ  (Viewçš„ä¸€éƒ¨åˆ†), ç”¨äºæ˜¾ç¤ºæ—¶é—´ã€åœ°ç‚¹ç­‰ç³»ç»Ÿä¿¡æ¯ -->
      <div class="info-bar">
        <span v-if="state.system.time || state.system.location || state.system.plot"> {{ formatSystemInfo }} </span>
        <span v-else>ç³»ç»Ÿä¿¡æ¯åŠ è½½ä¸­...</span>
      </div>

      <!-- ä¸»è¦å†…å®¹æ˜¾ç¤ºåŒºåŸŸ (Viewçš„ä¸€éƒ¨åˆ†) -->
      <div class="content-container">
        <div class="main-content">{{ state.mainContent }}</div>
      </div>

      <!-- å¼¹å‡ºé¢æ¿ (Viewçš„ä¸€éƒ¨åˆ†) -->
      <!-- é®ç½©å±‚ -->
      <Transition>
        <div v-if="activePopup" class="popup-overlay" @click="closePopup"></div>
      </Transition>
      <!-- é¢æ¿æœ¬èº« -->
      <Transition>
        <popup-panel
          v-if="activePopup"
          :is-active="!!activePopup"
          :position="getPopupPosition(activePopup)"
          :popup-id="activePopup"
          @close="closePopup"
        >
          <!-- ä½¿ç”¨æ’æ§½(slot)å°†æ ‡é¢˜å’Œå†…å®¹åŠ¨æ€ä¼ å…¥ popup-panel ç»„ä»¶ -->
          <template #title>{{ getPopupTitle(activePopup) }}</template>
          <template #content>
            <!-- æ ¹æ® activePopup çš„å€¼ï¼Œæ¡ä»¶æ€§åœ°æ¸²æŸ“ä¸åŒçš„é¢æ¿å†…å®¹ -->

            <!-- ç”¨æˆ·çŠ¶æ€é¢æ¿ -->
            <div v-if="activePopup === 'popup-user-status'">
              <div class="data-item">
                <strong>è½®å›æ¬¡æ•°:</strong>
                <span class="value value-display" ref="loopCountValueRef"
                  >{{ state.userStatus.loopCount || 'N/A' }}</span
                >
              </div>
              <div class="data-item">
                <strong>è½®å›å¤©æ•°:</strong>
                <span class="value value-display" ref="loopDaysValueRef">{{ state.userStatus.loopDays || 'N/A' }}</span>
              </div>
              <div class="data-item">
                <strong>ä½“åŠ›:</strong>
                <progress-bar :value="state.userStatus.hp" :max="100" color="var(--progress-my-hp-bar)" />
              </div>
              <div class="data-item">
                <strong>é­”åŠ›:</strong>
                <progress-bar :value="state.userStatus.mp" :max="100" color="var(--progress-my-mp-bar)" />
              </div>
              <div class="data-item">
                <strong>çµé­‚:</strong>
                <progress-bar
                  :value="state.userStatus.soulPurity"
                  :max="100"
                  color="var(--progress-my-soul-bar)"
                  text-color="#555"
                />
              </div>
              <div class="data-item">
                <strong>æœè£…:</strong> <span class="value">{{ state.userStatus.clothing || 'N/A' }}</span>
              </div>
              <div class="data-item">
                <strong>çŠ¶æ€:</strong> <span class="value">{{ state.userStatus.condition || 'N/A' }}</span>
              </div>
              <div class="data-item">
                <strong>åŠ¨ä½œ:</strong> <span class="value">{{ state.userStatus.action || 'N/A' }}</span>
              </div>
            </div>

            <!-- ç”¨æˆ·èƒŒåŒ…é¢æ¿ -->
            <div v-if="activePopup === 'popup-user-inventory'">
              <div class="data-item">
                <strong>æ‚²å¹ä¹‹ç§:</strong>
                <button
                  @click="useGriefSeed"
                  :disabled="!state.userInventory.griefSeeds || state.userInventory.griefSeeds <= 0"
                  class="item-button"
                  style="width: auto; padding: 4px 10px"
                >
                  <span class="value-display" ref="griefSeedsValueRef"
                    >{{ state.userInventory.griefSeeds || '0' }}</span
                  >
                  <span
                    v-if="state.userInventory.griefSeeds > 0"
                    style="margin-left: 8px; font-size: 0.9em; opacity: 0.8"
                    >(ç‚¹å‡»ä½¿ç”¨)</span
                  >
                </button>
              </div>
              <div class="data-item inventory-items">
                <strong>èƒŒåŒ…ç‰©å“:</strong>
                <div class="item-list">
                  <template v-if="state.userInventory.items && state.userInventory.items.length">
                    <button
                      v-for="item in state.userInventory.items"
                      :key="item"
                      @click="useItem(item)"
                      class="item-button"
                    >
                      {{ item }}
                    </button>
                  </template>
                  <span v-else class="value">ç©º</span>
                </div>
              </div>
            </div>

            <!-- æˆ˜æ–—ä¸èƒ½åŠ›é¢æ¿ -->
            <div v-if="activePopup === 'popup-combat'">
              <div class="data-item combat-items">
                <strong>é­”æ³•æŠ€èƒ½:</strong>
                <div class="item-list">
                  <template v-if="state.combat.skills && state.combat.skills.length">
                    <button
                      v-for="skill in state.combat.skills"
                      :key="skill"
                      @click="useSkill(skill)"
                      class="item-button"
                    >
                      {{ skill }}
                    </button>
                  </template>
                  <span v-else class="value">æ— </span>
                </div>
              </div>
              <div class="data-item combat-items">
                <strong>æ­¦å™¨:</strong>
                <div class="item-list">
                  <template v-if="state.combat.weapon && state.combat.weapon.length">
                    <!-- æ­¦å™¨åªç”¨äºå±•ç¤ºï¼Œä¸å¯ç‚¹å‡» -->
                    <span v-for="w in state.combat.weapon" :key="w" class="value" style="padding: 6px 0">{{ w }}</span>
                  </template>
                  <span v-else class="value">æ— </span>
                </div>
              </div>
            </div>

            <!-- åŒä¼´çŠ¶æ€é¢æ¿ -->
            <div v-if="activePopup === 'popup-companions'">
              <TransitionGroup name="list" tag="div" v-if="state.companions.length">
                <companion-card v-for="comp in state.companions" :key="comp.id" :companion="comp" />
              </TransitionGroup>
              <div v-else class="no-data-message">æš‚æ— åŒä¼´ä¿¡æ¯</div>
            </div>

            <!-- æ•Œäººé¢æ¿ -->
            <div v-if="activePopup === 'popup-enemies'">
              <TransitionGroup name="list" tag="div" v-if="state.enemies.length">
                <enemy-card v-for="(enemy, index) in state.enemies" :key="enemy.name + index" :enemy="enemy" />
              </TransitionGroup>
              <div v-else class="no-data-message">æš‚æ— æ•Œäººä¿¡æ¯</div>
            </div>

            <!-- é­”æ³•å°‘å¥³å°è´´å£«é¢æ¿ -->
            <div v-if="activePopup === 'popup-tips'">
              <TransitionGroup name="list" tag="div" v-if="state.tips.length">
                <tip-item v-for="(tip, index) in state.tips" :key="index" :tip="tip" @send="sendAsChatMessage" />
              </TransitionGroup>
              <div v-else class="no-data-message">æš‚æ— å°è´´å£«</div>
            </div>

            <!-- è°ƒè¯•é¢æ¿ -->
            <div v-if="activePopup === 'popup-debug'" class="debug-panel">
              <h4>åŸå§‹è¾“å…¥ (rawGameTxt)</h4>
              <pre>{{ rawGameTxt }}</pre>
              <h4>è§£æåçŠ¶æ€ (JSON)</h4>
              <pre>{{ JSON.stringify(state, null, 2) }}</pre>
            </div>

            <!-- è®¾ç½®é¢æ¿ -->
            <div vif="activePopup === 'popup-settings'" class="settings-panel">
              <div v-for="button in settableNavButtons" :key="button.id" class="setting-item">
                <span>{{ button.label }}</span>
                <button
                  @click="uiSettings[button.id].visible = !uiSettings[button.id].visible"
                  class="toggle-button"
                  :class="uiSettings[button.id].visible ? 'on' : 'off'"
                >
                  {{ uiSettings[button.id].visible ? 'å¼€å¯' : 'å…³é—­' }}
                </button>
              </div>
            </div>
          </template>
        </popup-panel>
      </Transition>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <div class="bottom-bar">
        <div class="bottom-popup-button" @click="togglePopup('popup-tips')">é­”æ³•å°‘å¥³å°è´´å£«</div>
      </div>
    </div>

    <script>
      'å®‰å…¨æ³¨é‡Šï¼šç”±äºSillyTavernçš„è„šæœ¬æ‰§è¡Œç¯å¢ƒé™åˆ¶ï¼Œä½¿ç”¨æ ‡å‡†çš„JSæ³¨é‡Š(/* */ æˆ– //)å¯èƒ½ä¼šå¯¼è‡´è„šæœ¬åŠ è½½å¤±è´¥ã€‚';
      'å› æ­¤ï¼Œæœ¬é¡¹ç›®ä¸­çš„æ‰€æœ‰JSæ³¨é‡Šéƒ½ä»¥è¿™ç§ç‹¬ç«‹çš„å­—ç¬¦ä¸²å­—é¢é‡å½¢å¼å­˜åœ¨ã€‚';

      const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

      ('==================================================================================');
      ('== 1. æ•°æ®è§£ææ¨¡å— (Parser) - MVUæ¨¡å¼ä¸­çš„æ ¸å¿ƒ "Update" é€»è¾‘çš„ç¬¬ä¸€éƒ¨åˆ†         ==');
      ('==================================================================================');
      ('æ­¤å‡½æ•°æ˜¯æ•´ä¸ªUIçš„â€œæ•°æ®å¿ƒè„â€ï¼Œè´Ÿè´£å°†SillyTavernä¼ æ¥çš„ã€éç»“æ„åŒ–çš„åŸå§‹æ–‡æœ¬ï¼Œè§£ææˆä¸€ä¸ªç»“æ„åŒ–çš„JavaScriptå¯¹è±¡ï¼ˆå³æˆ‘ä»¬çš„ Modelï¼‰ã€‚');
      ('å®ƒé‡‡ç”¨äº†çŠ¶æ€æœºï¼ˆState Machineï¼‰çš„è®¾è®¡æ€æƒ³æ¥é€è¡Œè§£ææ–‡æœ¬ï¼Œä½¿å…¶èƒ½å¤Ÿå¥å£®åœ°å¤„ç†å„ç§å¤æ‚çš„ã€åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ã€‚');
      ('å¤åˆ»åŸç†: è¦å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œä½ éœ€è¦ï¼š1. å®šä¹‰å¥½ä½ æœŸæœ›çš„è¾“å…¥æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚å„ç§æ ‡é¢˜å’Œå­—æ®µï¼‰ã€‚2. åˆ›å»ºä¸€ä¸ªç©ºçš„JSå¯¹è±¡ä½œä¸ºæ•°æ®æ¨¡æ¿ã€‚3. é€è¡Œè¯»å–æ–‡æœ¬ï¼Œä½¿ç”¨if/elseæˆ–switchåˆ¤æ–­å½“å‰è¡Œå±äºå“ªä¸ªéƒ¨åˆ†ã€‚4. æ ¹æ®é¢„è®¾çš„è§„åˆ™ï¼ˆå¦‚æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²ã€å¤šè¡Œæ‹¼æ¥ï¼‰æå–æ•°æ®å¹¶å¡«å……åˆ°JSå¯¹è±¡ä¸­ã€‚');
      function parseGameTxt(rawText) {
        'é¦–å…ˆï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†åˆ«æå– <content> å’Œ <status> æ ‡ç­¾å†…çš„å†…å®¹ã€‚';
        const contentMatch = rawText.match(/<content>([\s\S]*?)<\/content>/);
        const statusMatch = rawText.match(/<status>([\s\S]*?)<\/status>/);

        ('å®šä¹‰ä¸€ä¸ªåˆå§‹çš„ã€ç©ºçš„stateå¯¹è±¡ç»“æ„ã€‚è¿™æ˜¯MVUæ¨¡å¼ä¸­çš„Modelï¼ˆæ¨¡å‹ï¼‰çš„è“æœ¬ã€‚');
        ('å³ä½¿è§£æå¤±è´¥ï¼Œä¹Ÿä¼šè¿”å›è¿™ä¸ªåŸºæœ¬ç»“æ„ï¼Œé˜²æ­¢UIå´©æºƒã€‚');
        const initialState = {
          mainContent: 'å†…å®¹åŠ è½½å¤±è´¥ã€‚',
          system: {},
          userStatus: {},
          userInventory: {},
          combat: { skills: [], weapon: [] },
          companions: [],
          enemies: [],
          tips: [],
          userInventory: { griefSeeds: 'N/A', items: [] },
        };

        if (contentMatch) initialState.mainContent = contentMatch[1].trim();
        if (!statusMatch) return initialState;
        ('å¦‚æœstatuséƒ¨åˆ†ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œä¿è¯å¥å£®æ€§ã€‚');

        const statusText = statusMatch[1].trim();
        const lines = statusText.split(/\r?\n/);
        ('å°†statusæ–‡æœ¬æŒ‰è¡Œåˆ†å‰²æˆæ•°ç»„ã€‚');

        ('å®šä¹‰çŠ¶æ€æœºå˜é‡ï¼Œç”¨äºåœ¨è§£æè¿‡ç¨‹ä¸­è·Ÿè¸ªå½“å‰æ‰€å¤„çš„åŒºæ®µå’Œå¯¹è±¡ã€‚');
        let currentSection = null; // å½“å‰åŒºæ®µ (e.g., 'userStatus', 'companions')
        let currentCompanion = null; // å½“å‰æ­£åœ¨å¤„ç†çš„åŒä¼´å¯¹è±¡
        let currentEnemy = null; // å½“å‰æ­£åœ¨å¤„ç†çš„æ•Œäººå¯¹è±¡
        let lastKey = null; // ä¸Šä¸€ä¸ªè§£æåˆ°çš„é”®ï¼Œç”¨äºå¤„ç†å¤šè¡Œå€¼
        let lastObject = null; // ä¸Šä¸€ä¸ªæ­£åœ¨æ“ä½œçš„å¯¹è±¡
        let isCapturingItems = false; // ä¸€ä¸ªç‰¹æ®Šæ ‡å¿—ä½ï¼Œç”¨äºè§£å†³â€œèƒŒåŒ…ç‰©å“â€å¤šè¡Œæ–‡æœ¬çš„è§£æé—®é¢˜ã€‚

        ('sectionTitles: å°†AIè¾“å‡ºçš„ä¸­æ–‡æ ‡é¢˜æ˜ å°„åˆ°æˆ‘ä»¬å†…éƒ¨ä½¿ç”¨çš„è‹±æ–‡åŒºæ®µåã€‚');
        const sectionTitles = {
          ç³»ç»Ÿ: 'system',
          ç”¨æˆ·çš„çŠ¶æ€: 'userStatus',
          ç”¨æˆ·èƒŒåŒ…: 'userInventory',
          æˆ˜æ–—ç‰ˆå—: 'combat',
          åŒä¼´çŠ¶æ€: 'companions',
          æ•Œäºº: 'enemies',
          é­”æ³•å°‘å¥³å°è´´å£«: 'tips',
        };
        ('keyMap: å°†AIè¾“å‡ºçš„ä¸­æ–‡é”®åæ˜ å°„åˆ°JSå¯¹è±¡ä¸­çš„å±æ€§åã€‚è¿™ç§è®¾è®¡ä½¿å¾—å‰ç«¯å¯ä»¥çµæ´»åœ°é‡å‘½åå­—æ®µï¼Œè€Œæ— éœ€ä¿®æ”¹AIçš„è¾“å‡ºæ ¼å¼ã€‚');
        const keyMap = {
          æ—¶é—´: 'time',
          åœ°ç‚¹: 'location',
          ç°åœ¨æ—¶é—´æ®µåŸå‰§æƒ…: 'plot',
          è½®å›æ¬¡æ•°: 'loopCount',
          è½®å›å¤©æ•°: 'loopDays',
          ä½“åŠ›å€¼: 'hp',
          é­”æ³•å€¼: 'mp',
          çµé­‚çº¯å‡€åº¦: 'soulPurity',
          æœè£…: 'clothing',
          å½“å‰èº«ä½“çŠ¶æ€: 'condition',
          å½“å‰åŠ¨ä½œ: 'action',
          æ‚²å¹ä¹‹ç§: 'griefSeeds',
          èƒŒåŒ…ç‰©å“: 'items',
          é­”æ³•æŠ€èƒ½: 'skills',
          æ­¦å™¨: 'weapon',
          å§“å: 'name',
          å¥½æ„Ÿåº¦: 'affection',
          å†…å¿ƒæƒ³æ³•: 'thoughts',
          åå­—: 'name',
          ç”Ÿå‘½å€¼: 'hp',
          ç‰¹æ®Šæœºåˆ¶: 'mechanics',
        };

        ('å¼€å§‹é€è¡Œè§£æ');
        for (const line of lines) {
          const trimmedLine = line.trim();
          if (!trimmedLine) continue;
          ('å¿½ç•¥ç©ºè¡Œ');

          ('æ£€æŸ¥å½“å‰è¡Œæ˜¯å¦ä¸ºä¸€ä¸ªæ–°çš„åŒºæ®µæ ‡é¢˜');
          if (sectionTitles[trimmedLine]) {
            currentSection = sectionTitles[trimmedLine];
            ('é‡ç½®æ‰€æœ‰çŠ¶æ€æœºå˜é‡ï¼Œè¿›å…¥æ–°åŒºæ®µ');
            currentCompanion = null;
            currentEnemy = null;
            lastKey = null;
            lastObject = null;
            isCapturingItems = false;
            continue;
          }

          if (!currentSection) continue;
          ('å¦‚æœè¿˜æ²¡è¿›å…¥ä»»ä½•åŒºæ®µï¼Œå¿½ç•¥æ­¤è¡Œ');

          ('é’ˆå¯¹â€œé­”æ³•å°‘å¥³å°è´´å£«â€åŒºæ®µçš„ç‰¹æ®Šå¤„ç†é€»è¾‘');
          if (currentSection === 'tips') {
            const parts = trimmedLine.split(/[:ï¼š](.*)/s); // ä½¿ç”¨å…¼å®¹å…¨è§’/åŠè§’å†’å·çš„æ­£åˆ™åˆ†å‰²
            const tip = { comment: 'é­”æ³•é¡¾é—®', option: trimmedLine, clickable: true };
            if (parts.length > 1 && parts[1] && parts[1].trim()) {
              tip.comment = parts[0].trim();
              tip.option = parts[1].trim();
            }
            if (tip.option.includes('æš‚æ— å»ºè®®')) tip.clickable = false; // å¦‚æœæ˜¯â€œæš‚æ— å»ºè®®â€ï¼Œåˆ™è®¾ä¸ºä¸å¯ç‚¹å‡»
            initialState.tips.push(tip);
            continue;
          }

          ('å†å²ç»éªŒï¼šä¿®å¤äº†æ— æ³•è§£æå¤šä¸ªåŒä¼´çš„bugã€‚');
          ('è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œåœ¨åŒä¼´åŒºåŸŸï¼Œä¸€æ—¦é‡åˆ°ä»¥"npc"å¼€å¤´çš„è¡Œï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„åŒä¼´å¯¹è±¡ã€‚');
          if (currentSection === 'companions' && trimmedLine.toLowerCase().startsWith('npc')) {
            currentCompanion = { id: trimmedLine.split(/[:ï¼š]/)[1]?.trim() || Date.now() }; // ä½¿ç”¨idæˆ–æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€key
            initialState.companions.push(currentCompanion);
            lastObject = currentCompanion;
            lastKey = null;
            isCapturingItems = false;
            continue;
          }

          ('é€šç”¨é”®å€¼å¯¹è§£æé€»è¾‘');
          ('å†å²ç»éªŒï¼šè¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼ (.*)/s æ˜¯ä¸ºäº†æ­£ç¡®å¤„ç†å€¼ä¸­å¯èƒ½åŒ…å«å†’å·çš„æƒ…å†µã€‚');
          const parts = trimmedLine.split(/[:ï¼š](.*)/s);
          const key = parts[0].trim();
          const value = parts.length > 1 ? parts[1].trim() : '';

          ('ä¸ºâ€œèƒŒåŒ…ç‰©å“â€å¼€å¯ç‰¹æ®Šçš„å¤šè¡Œæ•æ‰æ¨¡å¼');
          if (currentSection === 'userInventory' && key === 'èƒŒåŒ…ç‰©å“') {
            isCapturingItems = true;
            initialState.userInventory.items = value ? [value] : [];
            lastObject = initialState.userInventory;
            lastKey = 'items';
            continue;
          }

          ('å†å²ç»éªŒï¼šå¤„ç†å¤šè¡Œå€¼çš„æ ¸å¿ƒé€»è¾‘ã€‚å¦‚æœä¸€è¡Œæ²¡æœ‰å†’å·ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“ä¸Šä¸€ä¸ªé”®æ˜¯ä»€ä¹ˆï¼Œå°±è®¤ä¸ºè¿™è¡Œæ˜¯ä¸Šä¸€ä¸ªå€¼çš„å»¶ç»­ã€‚');
          if (parts.length === 1 && lastKey && lastObject && lastKey in lastObject) {
            if (isCapturingItems) {
              initialState.userInventory.items.push(trimmedLine);
            } else if (lastKey === 'skills' || lastKey === 'weapon') {
              // å¦‚æœæ˜¯æŠ€èƒ½æˆ–æ­¦å™¨ï¼Œåˆ™æ·»åŠ åˆ°æ•°ç»„ä¸­
              if (lastObject[lastKey].length === 1 && lastObject[lastKey][0] === '') {
                lastObject[lastKey][0] = trimmedLine;
              } else {
                lastObject[lastKey].push(trimmedLine);
              }
            } else {
              // å…¶ä»–æƒ…å†µï¼Œç›´æ¥ç”¨æ¢è¡Œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²
              lastObject[lastKey] += (lastObject[lastKey] ? '\n' : '') + trimmedLine;
            }
            continue;
          }

          const mappedKey = keyMap[key];
          if (!mappedKey) continue;
          ('å¦‚æœé”®åä¸åœ¨æˆ‘ä»¬çš„æ˜ å°„è¡¨ä¸­ï¼Œåˆ™å¿½ç•¥');

          ('æ ¹æ®å½“å‰åŒºæ®µï¼Œç¡®å®šè¦æ“ä½œçš„ç›®æ ‡å¯¹è±¡');
          switch (currentSection) {
            case 'system':
              lastObject = initialState.system;
              break;
            case 'userStatus':
              lastObject = initialState.userStatus;
              break;
            case 'combat':
              lastObject = initialState.combat;
              break;
            case 'userInventory':
              lastObject = initialState.userInventory;
              break;
            case 'companions':
              lastObject = currentCompanion;
              break;
            case 'enemies':
              if (key === 'åå­—') {
                // é‡åˆ°â€œåå­—â€æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ•Œäººå¯¹è±¡
                currentEnemy = {};
                initialState.enemies.push(currentEnemy);
              }
              lastObject = currentEnemy;
              break;
          }
          if (lastObject) {
            ('å°†è§£æå‡ºçš„å€¼èµ‹ç»™ç›®æ ‡å¯¹è±¡');
            if (mappedKey === 'skills' || mappedKey === 'weapon') {
              lastObject[mappedKey] = value ? [value] : []; // æŠ€èƒ½å’Œæ­¦å™¨æ˜¯æ•°ç»„
            } else {
              lastObject[mappedKey] = value;
            }
            lastKey = mappedKey; // è®°å½•æœ€åæ“ä½œçš„é”®ï¼Œä»¥å¤‡å¤„ç†å¤šè¡Œå€¼
          }
        }
        return initialState;
      }

      ('==================================================================================');
      ('== 2. Vue åº”ç”¨å®šä¹‰ - é©±åŠ¨UIçš„æ ¸å¿ƒ                                               ==');
      ('==================================================================================');
      const app = createApp({
        setup() {
          '--- å“åº”å¼çŠ¶æ€ (Model) ---';
          'æ­¤ `state` å¯¹è±¡æ˜¯æœ¬åº”ç”¨ MVU (Model-View-Update) æ¨¡å¼ä¸­çš„ **Model** (æ¨¡å‹)ã€‚';
          'å®ƒé€šè¿‡ Vue çš„ `reactive` API åˆ›å»ºï¼ŒåŒ…å«äº†é©±åŠ¨æ•´ä¸ªUIæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚å½“å®ƒçš„ä»»ä½•å±æ€§è¢«ä¿®æ”¹æ—¶ï¼Œç›¸å…³çš„ **View** (è§†å›¾) éƒ½ä¼šè‡ªåŠ¨æ›´æ–°ã€‚';

          'æ ¸å¿ƒæœºåˆ¶ï¼š`rawGameTxt` çš„åˆå§‹å€¼æ˜¯ `$1`ã€‚åœ¨SillyTavernçš„æ­£åˆ™æ›¿æ¢åŠŸèƒ½ä¸­ï¼Œ`$1` ä¼šè¢«æ›¿æ¢ä¸ºç¬¬ä¸€ä¸ªæ•è·ç»„çš„å†…å®¹ï¼ˆå³<game_txt>æ ‡ç­¾å†…çš„æ‰€æœ‰æ–‡æœ¬ï¼‰ã€‚';
          'è¿™æ˜¯å®ç°æ•°æ®ä»SillyTavernæ³¨å…¥åˆ°Vueåº”ç”¨çš„å…¥å£ç‚¹å’Œå…³é”®ã€‚';
          const rawGameTxt = ref(`$1`);
          const state = reactive({
            mainContent: 'æ•…äº‹å†…å®¹åŠ è½½ä¸­...',
            system: {},
            userStatus: {},
            userInventory: { griefSeeds: 'N/A', items: [] },
            combat: { skills: [], weapon: [] },
            companions: [],
            enemies: [],
            tips: [],
          });
          const activePopup = ref(null); // å½“å‰æ¿€æ´»çš„å¼¹çª—ID
          ('ä¸ºéœ€è¦åŠ¨ç”»æ•ˆæœçš„DOMå…ƒç´ åˆ›å»ºå¼•ç”¨');
          const loopCountValueRef = ref(null);
          const loopDaysValueRef = ref(null);
          const griefSeedsValueRef = ref(null);
          const uiSettings = reactive({}); // å­˜å‚¨UIå…ƒç´ çš„å¯è§æ€§ç­‰è®¾ç½®

          ('--- å¯¼èˆªå’ŒUIé…ç½® ---');
          const navButtons = [
            { id: 'status', icon: 'â—‡', label: 'ä½ çš„çŠ¶æ€', popupId: 'popup-user-status' },
            { id: 'inventory', icon: 'â—', label: 'ä½ çš„èƒŒåŒ…', popupId: 'popup-user-inventory' },
            { id: 'combat', icon: 'âš”', label: 'æˆ˜æ–—ä¸èƒ½åŠ›', popupId: 'popup-combat' },
            { id: 'companions', icon: 'â™¡', label: 'åŒä¼´çŠ¶æ€', popupId: 'popup-companions' },
            { id: 'enemies', icon: 'â˜ ', label: 'æ•Œäºº', popupId: 'popup-enemies' },
            { id: 'debug', icon: 'ğŸ', label: 'è°ƒè¯•', popupId: 'popup-debug' },
            { id: 'settings', icon: 'âš™', label: 'è®¾ç½®', popupId: 'popup-settings' },
          ];

          const settableNavButtons = computed(() => navButtons.filter(b => b.id !== 'settings'));

          ('--- è®¡ç®—å±æ€§ (Computed Properties) ---');
          ('è®¡ç®—å±æ€§ç”¨äºæ ¹æ®stateæ´¾ç”Ÿå‡ºæ–°çš„æ•°æ®ï¼Œå½“ä¾èµ–çš„stateå˜åŒ–æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ã€‚');
          const formatSystemInfo = computed(() => {
            return [
              state.system.time ? `æ—¶é—´: ${state.system.time}` : '',
              state.system.location ? `åœ°ç‚¹: ${state.system.location}` : '',
              state.system.plot ? `ç°åœ¨æ—¶é—´æ®µåŸå‰§æƒ…: ${state.system.plot}` : '',
            ]
              .filter(Boolean)
              .join(' | ');
          });

          ('--- æ–¹æ³• (Methods) - MVUæ¨¡å¼ä¸­çš„ "Update" é€»è¾‘çš„ç¬¬äºŒéƒ¨åˆ† ---');
          ('è¿™äº›æ–¹æ³•å“åº”ç”¨æˆ·äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰å¹¶å¯èƒ½ä¿®æ”¹ "Model" (state)ã€‚');
          const togglePopup = popupId => {
            activePopup.value = activePopup.value === popupId ? null : popupId;
          };

          const closePopup = () => {
            activePopup.value = null;
          };

          const useGriefSeed = () => {
            if (state.userInventory.griefSeeds > 0) {
              sendAsChatMessage('ä½¿ç”¨ æ‚²å¹ä¹‹ç§');
            }
          };

          const getPopupTitle = popupId => navButtons.find(b => b.popupId === popupId)?.label || '';
          const getPopupPosition = popupId => (popupId === 'popup-tips' ? 'bottom-up' : 'top-down');

          ('æ ¸å¿ƒæœºåˆ¶ï¼šä¸SillyTaverné€šä¿¡çš„å‡½æ•°ã€‚');
          ('æ­¤å‡½æ•°æ˜¯ä¸SillyTavernä¸»ç•Œé¢é€šä¿¡çš„æ¡¥æ¢ã€‚å®ƒä½¿ç”¨äº†å®˜æ–¹åœ¨ `@types/iframe/exported.sillytavern.d.ts` ä¸­å®šä¹‰çš„ `createChatMessages` å’Œ `triggerSlash` å…¨å±€å‡½æ•°ã€‚');
          ('å¤åˆ»åŸç†: 1. æ£€æŸ¥ `typeof createChatMessages === "function"` æ¥åˆ¤æ–­æ˜¯å¦åœ¨SillyTavernç¯å¢ƒä¸­ã€‚ 2. è°ƒç”¨ `createChatMessages` å¹¶ä¼ å…¥ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡æ•°ç»„ï¼ˆä¾‹å¦‚ `[{ role: "user", message: "..." }]`ï¼‰æ¥æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯ã€‚ 3. (å¯é€‰) è°ƒç”¨ `triggerSlash("/trigger")` æ¥æç¤ºAIè¿›è¡Œå›å¤ã€‚');
          const sendAsChatMessage = message => {
            if (typeof createChatMessages === 'function' && typeof triggerSlash === 'function') {
              (async () => {
                await createChatMessages([{ role: 'user', message: message }]);
                triggerSlash('/trigger');
              })();
            } else {
              console.warn('SillyTavern API not found.');
              alert(`åœ¨SillyTavernç¯å¢ƒå¤–æ— æ³•å‘é€æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹ï¼š\n${message}`);
            }
          };

          const useItem = itemString => {
            const itemName = itemString.split(/x\d*$/)[0].trim(); // ä» "ç‰©å“xN" çš„æ ¼å¼ä¸­æå–ç‰©å“å
            if (itemName) {
              sendAsChatMessage(`ä½¿ç”¨ ${itemName}`);
            }
          };

          const useSkill = skillName => {
            sendAsChatMessage(`ä½¿ç”¨ ${skillName}`);
          };

          ('ä¸ºDOMå…ƒç´ åº”ç”¨é—ªçƒåŠ¨ç”»ï¼Œä»¥å¯è§†åŒ–æ•°å€¼å˜åŒ–');
          const applyChangeAnimation = (element, newValue, oldValue) => {
            if (!element || newValue === oldValue) return;
            const newNum = parseFloat(newValue);
            const oldNum = parseFloat(oldValue);
            if (isNaN(newNum) || isNaN(oldNum)) return;

            const changeClass = newNum > oldNum ? 'value-changed-up' : 'value-changed-down';
            element.classList.add(changeClass);
            setTimeout(() => {
              element.classList.remove(changeClass);
            }, 700);
          };

          ('--- ç”Ÿå‘½å‘¨æœŸé’©å­ (Lifecycle Hooks) ---');
          ('æ­¤å‡½æ•°æ˜¯ Vue çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œåœ¨ç»„ä»¶è¢«æŒ‚è½½åˆ° DOM åæ‰§è¡Œã€‚å®ƒç­‰åŒäº jQuery çš„ `$(document).ready()`ã€‚');
          ('æ ¹æ®å®˜æ–¹ `è„šæœ¬ç¤ºä¾‹` çš„å®è·µï¼Œè¿™é‡Œæ˜¯æ‰§è¡Œæ‰€æœ‰åˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚åŠ è½½è®¾ç½®ã€é¦–æ¬¡è§£ææ•°æ®ï¼‰çš„æœ€ä½³ä½ç½®ã€‚');
          onMounted(() => {
            'åŠ è½½UIè®¾ç½®ï¼šä»localStorageè¯»å–ç”¨æˆ·ä¿å­˜çš„UIå¯è§æ€§è®¾ç½®ï¼Œå®ç°æŒä¹…åŒ–ã€‚è¿™æ˜¯æ ‡å‡†çš„Webå¼€å‘å®è·µã€‚';
            const savedSettings = localStorage.getItem('tavernHelperUISettings');
            const defaultSettings = navButtons.reduce((acc, btn) => {
              acc[btn.id] = { visible: true };
              return acc;
            }, {});

            if (savedSettings) {
              Object.assign(uiSettings, { ...defaultSettings, ...JSON.parse(savedSettings) });
            } else {
              Object.assign(uiSettings, defaultSettings);
            }

            ('ç›‘è§†è®¾ç½®å˜åŒ–å¹¶è‡ªåŠ¨ä¿å­˜åˆ° localStorageã€‚');
            watch(
              uiSettings,
              newSettings => {
                localStorage.setItem('tavernHelperUISettings', JSON.stringify(newSettings));
              },
              { deep: true },
            );

            ('æ ¸å¿ƒé€»è¾‘ï¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶ï¼Œæ‰§è¡Œé¦–æ¬¡çš„ **Update** æ“ä½œï¼Œå°†æ³¨å…¥çš„åŸå§‹æ–‡æœ¬ `rawGameTxt` è§£æåï¼Œå¡«å……åˆ° **Model** (`state`) ä¸­ï¼Œä»è€Œå®ŒæˆUIçš„é¦–æ¬¡æ¸²æŸ“ã€‚');
            const parsedData = parseGameTxt(rawGameTxt.value);
            Object.assign(state, parsedData);

            ('ç›‘è§†ç‰¹å®šæ•°å€¼çš„å˜åŒ–ï¼Œä»¥è§¦å‘å¯¹åº”çš„åŠ¨ç”»æ•ˆæœã€‚');
            watch(
              () => state.userStatus.loopCount,
              (newVal, oldVal) => applyChangeAnimation(loopCountValueRef.value, newVal, oldVal),
            );
            watch(
              () => state.userStatus.loopDays,
              (newVal, oldVal) => applyChangeAnimation(loopDaysValueRef.value, newVal, oldVal),
            );
            watch(
              () => state.userInventory.griefSeeds,
              (newVal, oldVal) => applyChangeAnimation(griefSeedsValueRef.value, newVal, oldVal),
            );
          });

          ('è¿”å›æ‰€æœ‰éœ€è¦åœ¨æ¨¡æ¿ï¼ˆViewï¼‰ä¸­ç”¨åˆ°çš„æ•°æ®ï¼ˆModelï¼‰å’Œæ–¹æ³•ï¼ˆUpdateï¼‰ã€‚');
          return {
            state,
            rawGameTxt,
            activePopup,
            loopCountValueRef,
            loopDaysValueRef,
            griefSeedsValueRef,
            uiSettings,
            navButtons,
            settableNavButtons,
            formatSystemInfo,
            togglePopup,
            closePopup,
            getPopupTitle,
            getPopupPosition,
            sendAsChatMessage,
            useItem,
            useSkill,
            useGriefSeed,
          };
        },
      });

      ('==================================================================================');
      ('== 3. Vue ç»„ä»¶å®šä¹‰ (View Components) - MVUæ¨¡å¼ä¸­çš„ "View" çš„å¯å¤ç”¨éƒ¨åˆ†         ==');
      ('==================================================================================');
      ('æ­¤éƒ¨åˆ†å®šä¹‰äº†å¤šä¸ªå¯å¤ç”¨çš„UIç»„ä»¶ï¼Œæ„æˆäº† MVU æ¨¡å¼ä¸­çš„ **View** (è§†å›¾)ã€‚');
      ('è¿™ç§ç»„ä»¶åŒ–çš„æ–¹æ³•æ˜¯ Vue çš„æ ¸å¿ƒæ€æƒ³ï¼Œä¹Ÿä¸å®˜æ–¹ `ç•Œé¢ç¤ºä¾‹` ä¸­å°†UIæ‹†åˆ†ä¸º `æ—¥è®°.vue`ã€`é€‰æ‹©æ¡†.vue` ç­‰å¤šä¸ªæ–‡ä»¶çš„å®è·µç›¸ç¬¦ï¼Œæå¤§åœ°æé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚');

      ('é€šç”¨å¼¹å‡ºé¢æ¿ç»„ä»¶');
      app.component('popup-panel', {
        props: ['isActive', 'position', 'popupId'],
        emits: ['close'],
        template: `
        <div class="popup-panel" :class="[position, popupId]">
            <div class="popup-header">
                <h3 class="popup-title"><slot name="title"></slot></h3>
                <span class="popup-close-btn" @click="$emit('close')">&times;</span>
            </div>
            <div class="popup-content"><slot name="content"></slot></div>
        </div>
    `,
      });

      ('å¸¦åŠ¨ç”»çš„è¿›åº¦æ¡ç»„ä»¶');
      app.component('progress-bar', {
        props: {
          value: [String, Number],
          max: { type: Number, default: 100 },
          color: String,
          textColor: { type: String, default: '#fff' },
        },
        setup(props) {
          const animatedValue = ref(0);
          const displayValue = computed(() => Math.round(animatedValue.value));
          const percentage = computed(() => (animatedValue.value / props.max) * 100);

          ('å½“å¤–éƒ¨ä¼ å…¥çš„ `value` å˜åŒ–æ—¶ï¼Œä½¿ç”¨ GSAP åŠ¨ç”»åº“å°† `animatedValue` å¹³æ»‘åœ°è¿‡æ¸¡åˆ°æ–°å€¼ã€‚');
          watch(
            () => props.value,
            newValue => {
              gsap.to(animatedValue, { duration: 0.8, value: parseFloat(newValue) || 0, ease: 'power2.out' });
            },
            { immediate: true },
          );

          return { displayValue, percentage };
        },
        template: `
        <div class="progress-bar-container">
            <div class="progress-bar-fill" :style="{ width: percentage + '%', background: color }"></div>
            <span class="progress-bar-text" :style="{ color: textColor }">{{ displayValue }} / {{ max }}</span>
        </div>
    `,
      });

      ('åŒä¼´ä¿¡æ¯å¡ç‰‡ç»„ä»¶');
      app.component('companion-card', {
        props: ['companion'],
        template: `
        <div class="card-block companion-card">
            <h4>{{ companion.name || 'æœªçŸ¥åŒä¼´' }}</h4>
            <div class="data-item"><strong>ä½“åŠ›:</strong> <progress-bar :value="companion.hp" color="var(--progress-my-hp-bar)" /></div>
            <div class="data-item"><strong>é­”åŠ›:</strong> <progress-bar :value="companion.mp" color="var(--progress-my-mp-bar)" /></div>
            <div class="data-item"><strong>å¥½æ„Ÿ:</strong> <progress-bar :value="companion.affection" :max="200" :min="-100" color="var(--progress-comp-aff-bar)" text-color="#6f4e00" /></div>
            <div class="data-item"><strong>çµé­‚:</strong> <progress-bar :value="companion.soulPurity" color="var(--progress-my-soul-bar)" text-color="#555" /></div>
            <div class="data-item"><strong>æ‚²å¹ä¹‹ç§:</strong> <span class="value">{{ companion.griefSeeds || 'N/A' }}</span></div>
            <div class="data-item"><strong>å¿ƒå£°:</strong> <span class="value">{{ companion.thoughts || 'N/A' }}</span></div>
            <div class="data-item"><strong>æœè£…:</strong> <span class="value">{{ companion.clothing || 'N/A' }}</span></div>
            <div class="data-item"><strong>åŠ¨ä½œ:</strong> <span class="value">{{ companion.action || 'N/A' }}</span></div>
        </div>
    `,
      });

      ('æ•Œäººä¿¡æ¯å¡ç‰‡ç»„ä»¶');
      app.component('enemy-card', {
        props: ['enemy'],
        template: `
        <div class="card-block enemy-card">
            <h4>{{ enemy.name || 'æœªçŸ¥æ•Œäºº' }}</h4>
            <div class="data-item"><strong>ç”Ÿå‘½:</strong> <progress-bar :value="enemy.hp" color="var(--progress-enemy-hp-bar)" /></div>
            <div class="data-item"><strong>æœºåˆ¶:</strong> <span class="value">{{ enemy.mechanics || 'N/A' }}</span></div>
        </div>
    `,
      });

      ('é­”æ³•å°‘å¥³å°è´´å£«æ¡ç›®ç»„ä»¶');
      app.component('tip-item', {
        props: ['tip'],
        emits: ['send'],
        template: `
        <div class="tip-item" :class="{ clickable: tip.clickable }" @click="tip.clickable && $emit('send', tip.option)">
            <div class="tip-header">âœ§ {{ tip.comment }}</div>
            <div class="tip-content">{{ tip.option }}</div>
        </div>
    `,
      });

      ('==================================================================================');
      ('== 4. æŒ‚è½½åº”ç”¨ - è®©Vueæ¥ç®¡é¡µé¢                                                    ==');
      ('==================================================================================');
      ('æœ€åï¼Œè°ƒç”¨ `app.mount` å°†æˆ‘ä»¬åˆ›å»ºçš„Vueåº”ç”¨å®ä¾‹æŒ‚è½½åˆ°HTMLä¸­IDä¸º`app`çš„DOMå…ƒç´ ä¸Šï¼Œä»è€Œè®©æ•´ä¸ªåº”ç”¨ç”Ÿæ•ˆã€‚');
      app.mount('#app');
    </script>
  </body>
</html>
